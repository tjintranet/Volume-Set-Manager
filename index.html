<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Volume Set Manager</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body {
            background-color: #f8f9fa;
            padding: 20px;
        }
        .custom-card {
            max-width: 800px;
            margin: 0 auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card custom-card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h4 class="card-title mb-0">Volume Set Manager</h4>
            </div>
            <div class="card-body">
                <!-- Alert for errors -->
                <div class="alert alert-danger alert-dismissible fade show d-none" role="alert" id="error">
                    <span id="errorMessage"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>

                <!-- File Upload Section -->
                <div class="mb-4">
                    <label for="fileUpload" class="form-label">Import from Excel</label>
                    <input type="file" class="form-control mb-2" id="fileUpload" accept=".xlsx,.xls">
                    <div>
                        <a href="https://raw.githubusercontent.com/tjintranet/Volume-Set-Manager/main/template.xlsx" 
                           class="link-primary text-decoration-none" 
                           id="templateDownload">
                            <i class="bi bi-download me-1"></i>Download Excel Template
                        </a>
                    </div>
                    <div class="mt-2 text-muted small">
                        <p class="mb-1">Template format:</p>
                        <ul>
                            <li>Row 1: Headers (ISBN, Description)</li>
                            <li>Row 2: Set ISBN and Description</li>
                            <li>Row 3+: Volume ISBNs and Descriptions</li>
                        </ul>
                    </div>
                </div>

                <!-- Set ISBN -->
                <div class="mb-3">
                    <label for="setISBN" class="form-label">Set ISBN</label>
                    <input type="text" class="form-control" id="setISBN" placeholder="Enter 13-digit ISBN">
                </div>

                <!-- Set Description -->
                <div class="mb-3">
                    <label for="setDescription" class="form-label">Set Description</label>
                    <input type="text" class="form-control" id="setDescription" placeholder="Enter set description">
                </div>

                <!-- Volume ISBNs -->
                <div class="mb-3">
                    <label class="form-label">Volume ISBNs</label>
                    <div id="volumesContainer"></div>
                </div>

                <!-- Buttons -->
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary" onclick="addVolume()">
                        <i class="bi bi-plus-lg me-1"></i>Add Volume
                    </button>
                    <button class="btn btn-primary" onclick="generateCSV()">
                        <i class="bi bi-file-earmark-arrow-down me-1"></i>Generate CSV
                    </button>
                    <button class="btn btn-danger" onclick="resetForm()">
                        <i class="bi bi-trash me-1"></i>Reset
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- SheetJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // Initial volume input
        let volumes = [''];
        
        // ISBN-13 validation with checksum verification
        function isValidISBN(isbn) {
            const cleaned = isbn.replace(/[-\s]/g, '');
            
            if (!/^\d{13}$/.test(cleaned)) {
                return false;
            }
            
            let sum = 0;
            for (let i = 0; i < 12; i++) {
                sum += parseInt(cleaned[i]) * (i % 2 === 0 ? 1 : 3);
            }
            
            const checkDigit = (10 - (sum % 10)) % 10;
            return checkDigit === parseInt(cleaned[12]);
        }

        // Create volume input row
        function createVolumeRow(index, value = '') {
            const row = document.createElement('div');
            row.className = 'input-group mb-2';
            
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'form-control';
            input.value = value;
            input.placeholder = 'Enter volume ISBN';
            input.oninput = (e) => updateVolume(index, e.target.value);
            
            const buttonDiv = document.createElement('div');
            buttonDiv.className = 'input-group-append';
            
            const removeBtn = document.createElement('button');
            removeBtn.className = 'btn btn-outline-danger';
            removeBtn.innerHTML = '<i class="bi bi-trash"></i>';
            removeBtn.onclick = () => removeVolume(index);
            
            row.appendChild(input);
            row.appendChild(removeBtn);
            return row;
        }

        // Render volumes
        function renderVolumes() {
            const container = document.getElementById('volumesContainer');
            container.innerHTML = '';
            volumes.forEach((volume, index) => {
                container.appendChild(createVolumeRow(index, volume));
            });
        }

        // Add new volume input
        function addVolume() {
            volumes.push('');
            renderVolumes();
        }

        // Remove volume input
        function removeVolume(index) {
            volumes = volumes.filter((_, i) => i !== index);
            if (volumes.length === 0) volumes = [''];
            renderVolumes();
        }

        // Update volume ISBN
        function updateVolume(index, value) {
            volumes[index] = value;
        }

        // Show error message
        function showError(message) {
            const error = document.getElementById('error');
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.textContent = message;
            error.classList.remove('d-none');
        }

        // Hide error message
        function hideError() {
            const error = document.getElementById('error');
            error.classList.add('d-none');
        }

        // Reset form function
        function resetForm() {
            document.getElementById('setISBN').value = '';
            document.getElementById('setDescription').value = '';
            document.getElementById('fileUpload').value = '';
            volumes = [''];
            renderVolumes();
            hideError();
        }

        // Generate CSV
        function generateCSV() {
            const setISBN = document.getElementById('setISBN').value;
            const setDescription = document.getElementById('setDescription').value;

            if (!isValidISBN(setISBN)) {
                showError('Invalid ISBN-13 format or checksum. Please enter a valid ISBN-13 number.');
                return;
            }

            if (!setDescription.trim()) {
                showError('Set description is required');
                return;
            }

            const validVolumes = volumes.filter(v => v.trim());
            if (!validVolumes.length) {
                showError('At least one volume ISBN is required');
                return;
            }

            if (!validVolumes.every(isValidISBN)) {
                showError('One or more volume ISBNs are invalid. Please ensure all ISBNs are valid ISBN-13 numbers.');
                return;
            }

            hideError();

            const cleanSetISBN = setISBN.replace(/[-\s]/g, '');
            const cleanVolumeISBNs = validVolumes
                .map(isbn => isbn.replace(/[-\s]/g, ''))
                .join(';');

            const csvContent = `ISBN,NEW,${cleanSetISBN},${setDescription},,,,,,,,,N,,,,,,,,,,,,,${cleanVolumeISBNs}`;
            const timestamp = new Date().toISOString().replace(/[:.]/g, '_');
            const filename = `${timestamp}_${cleanSetISBN}_2.csv`;
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // Handle file upload
        document.getElementById('fileUpload').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            try {
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data, {
                    type: 'array',
                    cellDates: true,
                    cellNF: true,
                    cellText: true
                });

                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});

                if (jsonData.length < 2) {
                    showError('Invalid Excel file format. File should contain at least one set and one volume.');
                    return;
                }

                const setData = jsonData[1];
                if (!setData || !setData[0]) {
                    showError('Set ISBN is missing in the Excel file.');
                    return;
                }

                const setIsbn = setData[0].toString().trim();
                if (!isValidISBN(setIsbn)) {
                    showError(`Invalid set ISBN: ${setIsbn}. Please ensure it's a valid ISBN-13.`);
                    return;
                }

                const volumeData = jsonData.slice(2);
                const invalidVolumes = [];
                const validVolumes = [];

                volumeData.forEach((row, index) => {
                    if (row[0]) {
                        const isbn = row[0].toString().trim();
                        if (!isValidISBN(isbn)) {
                            invalidVolumes.push(`Row ${index + 3}: ${isbn}`);
                        } else {
                            validVolumes.push(isbn);
                        }
                    }
                });

                if (invalidVolumes.length > 0) {
                    showError(`Invalid volume ISBNs found:\n${invalidVolumes.join('\n')}`);
                    return;
                }

                if (validVolumes.length === 0) {
                    showError('No valid volume ISBNs found in the Excel file.');
                    return;
                }

                resetForm();

                document.getElementById('setISBN').value = setIsbn;
                document.getElementById('setDescription').value = setData[1] ? setData[1].toString().trim() : '';

                volumes = validVolumes;
                renderVolumes();

                hideError();
                e.target.value = '';
                
            } catch (error) {
                console.error('Error processing file:', error);
                showError('Error processing Excel file. Please ensure it\'s a valid Excel file with the correct format.');
            }
        });

        // Initial render
        renderVolumes();
    </script>
</body>
</html>